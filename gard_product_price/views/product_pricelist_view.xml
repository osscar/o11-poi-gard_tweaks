<?xml version="1.0"?>
<odoo>

    <!-- Search Views -->
    <record id="product_pricelist_item_view_search" model="ir.ui.view">
        <field name="name">product.pricelist.item.view.search</field>
        <field name="model">product.pricelist.item</field>
        <field name="arch" type="xml">

            <search string="Pricelist Items Search">
                <field name="name"
                    filter_domain="['|','|','|',('description','ilike',self),('product_id','ilike',self),('product_tmpl_id','ilike',self),('pricelist_id','ilike',self)]" />
                <field name="product_id"
                    filter_domain="['|',('product_id','ilike',self),('product_tmpl_id','ilike',self)]" />
                <field name="pricelist_id" />
                <field name="partner_ids" />
                <filter string="Partner Rules" name="partner_rules"
                    domain="[('partner_ids', '!=', False)]"
                    context="{}" />
                <filter string="Active" name="active_pricelist_true"
                    domain="[('active_pricelist', '=', True)]" context="{}" />
                <filter string="Archived" name="active_pricelist_false"
                    domain="[('active_pricelist', '=', False)]" context="{}" />
                <group expand="0" string="Group By">
                    <filter string="Product" name="group_product_id"
                        context="{'group_by':'product_id'}" />
                    <filter string="Product Code" name="group_product_default_code"
                        context="{'group_by':'product_default_code'}" />
                    <filter string="Pricelist" name="group_pricelist_id"
                        context="{'group_by':'pricelist_id'}" />
                    <filter string="Partner" name="group_partner_id"
                        context="{'group_by':'partner_ids'}" />
                    <filter string="Active" name="group_active_pricelist"
                        context="{'group_by':'active_pricelist'}" />
                </group>
            </search>

        </field>
    </record>

    <record id="product_pricelist_view_search" model="ir.ui.view">
        <field name="name">product.pricelist.view.search.inherit.gard_product_price</field>
        <field name="model">product.pricelist</field>
        <field name="mode">extension</field>
        <field name="inherit_id" ref="product.product_pricelist_view_search" />
        <field name="arch" type="xml">

            <xpath expr="//field[@name='name']" position="after">
                <field name="partner_ids" />
                <filter string="Partner Rules" name="partner_rules"
                    domain="[('partner_ids', '!=', False)]" />
                <filter string="All" name="active_all"
                    domain="['|', ('active', '=', True), ('active', '=', False)]" />
            </xpath>

            <xpath expr="//filter[@name='inactive']" position="before">
                <group expand="0" string="Group By">
                    <filter string="Partner" name="group_partner_id"
                        context="{'group_by':'partner_ids'}" />
                    <filter string="Active" name="group_active" context="{'group_by':'active'}" />
                </group>
            </xpath>

        </field>
    </record>

    <!-- Views -->
    <record id="product_pricelist_view_tree" model="ir.ui.view">
        <field name="name">product.pricelist.view.tree.inherit.gard_product_price</field>
        <field name="model">product.pricelist</field>
        <field name="mode">extension</field>
        <field name="inherit_id" ref="product.product_pricelist_view_tree" />
        <field name="arch" type="xml">

            <xpath expr="//field[@name='name']" position="before">
                <field name="item_ids" widget="label_selection" class="label label-success" />
            </xpath>

            <xpath expr="//field[@name='currency_id']" position="before">
                <field name="partner_ids" widget="many2many_tags" />
            </xpath>

        </field>
    </record>

    <record id="product_pricelist_view" model="ir.ui.view">
        <field name="name">product.pricelist.view.inherit.gard_product_price</field>
        <field name="model">product.pricelist</field>
        <field name="mode">extension</field>
        <field name="inherit_id" ref="product.product_pricelist_view" />
        <field name="arch" type="xml">

            <!-- added security  group -->
            <xpath expr="//sheet" position="attributes">
                <attribute name="groups">gard_product_price.group_product_price_manager</attribute>
            </xpath>

            <xpath expr="//div[2]" position="after">
                <group name="options">
                    <field name="is_hidden" />
                </group>
            </xpath>

            <!-- added partners -->
            <xpath expr="//field[@name='company_id']" position="after">
                <field name="partner_ids" widget="many2many_tags" placeholder="Select partners." />
            </xpath>

            <!-- added redirect to custom view -->
            <xpath expr="//field[@name='item_ids']" position="replace">
                <field name="item_ids"
                    context="{'tree_view_ref' : 'gard_product_price.product_pricelist_item_view_tree'}" />
            </xpath>

        </field>
    </record>

    <record id="product_pricelist_item_view_tree" model="ir.ui.view">
        <field name="name">product.pricelist.item.view.tree.gard_product_price</field>
        <field name="model">product.pricelist.item</field>
        <field name="type">tree</field>
        <field name="arch" type="xml">

            <!-- TO DO: decoration & colors -->
            <tree string="Pricelist Items" decoration-danger="partner_ids"
                default_order='description asc, min_quantity asc'>
                <field invisible="1" name="active_pricelist" />
                <field invisible="1" name="currency_id" />
                <field invisible="1" name="name" />
                <field invisible="1" name="product_id" />
                <field invisible="1" name="product_tmpl_id" />
                <field name="product_default_code" />
                <field colspan="4" name="description" />
                <field name="min_quantity" />
                <field name="min_quantity_uom_id" />
                <field name="price_unit" />
                <field name="margin_sale_net_unit"
                    groups="gard_product_price.group_product_price_manager" />
                <field name="min_quantity_pack" />
                <field name="uom_pack_id" />
                <field name="price_pack" />
                <field name="margin_sale_net_pack"
                    groups="gard_product_price.group_product_price_manager" />
                <field name="margin_sale_net_factor"
                    groups="gard_product_price.group_product_price_manager" />
                <field name="margin_sale_excl"
                    groups="gard_product_price.group_product_price_manager" />
                <field name="cost_product" groups="gard_product_price.group_product_price_manager" />
                <field name="pricelist_id" />
                <field name="partner_ids" widget="many2many_tags" />
                <field name="branch_id" />
                <field name="date_update" />
            </tree>

        </field>
    </record>

    <record id="product_pricelist_item_form_view" model="ir.ui.view">
        <field name="name">product.pricelist.item.form.inherit.gard_product_price</field>
        <field name="model">product.pricelist.item</field>
        <field name="mode">extension</field>
        <field name="inherit_id" ref="product.product_pricelist_item_form_view" />
        <!-- added security  group -->
        <!-- <field name="priority">19</field> -->
        <field name="groups_id" eval="[(4, ref('group_product_price_manager'))]" />
        <field name="arch" type="xml">

            <!-- mod base field colspan -->
            <xpath expr="//field[@name='base']" position="replace">
            </xpath>
            <!-- replace base_pricelist_id field -->
            <xpath expr="//field[@name='base_pricelist_id']" position="replace">
            </xpath>

            <xpath expr="//form/group[2]" position="after">
                <group>
                    <field name="base" colspan="6" />
                    <field name="base_pricelist_id"
                        attrs="{'required': [('base','=', 'pricelist')]}" />
                </group>
            </xpath>
            <!-- add date_update field: also used for recomputation of items with related
      base_pricelist_id -->
            <xpath expr="//field[@name='date_end']" position="after">
                <field name="date_update" />
            </xpath>
            <xpath expr="//field[@name='min_quantity']" position="after">
                <field name="min_quantity_uom_id" />
            </xpath>
            <xpath expr="/form//group" position="inside">
                <group>
                    <field invisible="1" name="currency_id" />
                    <field name="active_pricelist" />
                    <field name="is_hidden" />
                    <field name="description" />
                </group>
                <group>
                    <field name="price_unit" />
                    <field name="min_quantity_uom_id" />
                    <field name="margin_sale_net_unit" groups="gard_product_price.group_product_price_manager" force_save="1" />
                    <field name="min_quantity_pack" />
                    <field name="uom_pack_id" />
                    <field name="price_pack" />
                    <field name="margin_sale_net_pack" groups="gard_product_price.group_product_price_manager" force_save="1" />
                </group>
                <group>
                    <field name="partner_ids" widget="many2many_tags" />
                    <field name="branch_id" />
                    <field name="pricelist_id" />
                </group>
                <group groups="gard_product_price.group_product_price_manager">
                    <field name="margin_sale_net_factor" groups="gard_product_price.group_product_price_manager" force_save="1" />
                    <field name="margin_sale_excl" groups="gard_product_price.group_product_price_manager" />
                    <field name="cost_product" groups="gard_product_price.group_product_price_manager" />
                </group>
            </xpath>

            <xpath expr="/form/group[2]/group/div/div[2]" position="replace">
                <div
                    attrs="{'invisible':[('compute_price', 'not in', ['percentage', 'percentage_surcharge'])]}">
                    <field name="percent_price" nolabel="1" class="oe_inline" />
                    <!-- %% -->
                </div>
            </xpath>
            <form position="inside">
                <separator/>
                <div class="oe_chatter">
                    <field name="message_follower_ids" widget="mail_followers"/>
                    <field name="activity_ids" widget="mail_activity"/>
                    <field name="message_ids" widget="mail_thread"/>
                </div>
            </form>

        </field>
    </record>

    <!-- Actions -->
    <record id="product_pricelist_item_action_view_tree" model="ir.actions.act_window">
        <field name="name">Pricelist Items</field>
        <field name="type">ir.actions.act_window</field>
        <field name="res_model">product.pricelist.item</field>
        <field name="view_id" ref="gard_product_price.product_pricelist_item_view_tree" />
        <field name="view_type">form</field>
        <field name="view_mode">tree,form,kanban,pivot</field>
        <field name="context">{'search_default_group_pricelist_id': 1}</field>
        <field name="search_view_id" ref="gard_product_price.product_pricelist_item_view_search" />
    </record>

    <record id="product.product_pricelist_action2_tree" model="ir.actions.act_window.view">
        <field name="view_mode">tree</field>
        <field name="search_view_id" ref="gard_product_price.product_pricelist_view_search" />
        <field name="act_window_id" ref="product.product_pricelist_action2" />
    </record>

    <!-- Menus -->


</odoo>